<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" type="text/css">
    <link href="/static/plugins/fontawesome-free-5.15.4-web/css/all.css" rel="stylesheet" type="text/css" />
    <link href="/static/css/compassRoss.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.7.0/css/ol.css" type="text/css">
    <style type="text/css">
        .map {
          height: 400px;
          width: 100%;
        }
        body {
            background-color: black;
            font-size: 9px;
            font-family: 'Arial';
        }
        .vl {
          height: 500px;
          float: left;
        }

        .badge {
            min-width: 28px;
            border-radius: 0px !important;
        }

        .row {
            border: 1px solid #ccc;
        }
    </style>

    <title>Rocket Monitoring & Demonstration</title>
</head>
<body>
<div class="container" >
    <div class="row" style="border-top: 1px solid #ccc;border-bottom: 1px solid #ccc;padding:0 !important;">
        <div class="col-md-6">
            <div class="row" style="border-right: 1px solid #ccc;border-left: 1px solid #ccc;">
                <div class="col-md-12">
                    <span class="badge badge-warning">Dashboard</span>
                    <div class="" style="width:100%;height:257px;margin-bottom: 18px;margin-top: 5px;" id="chart2"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6" style="padding:0 !important;" >
                        <span style="position:absolute;" class="badge badge-warning">Live Camera <span style="color:green">(On Line)</span></span>
                        <center><img class="" src="{{ url_for('video_feed') }}" style="width:100%;margin: 0;"></center>
                </div>
                <div   id="nav" align="middle" class="col-md-6" style="background-color: #fff; ">
                    <span class="badge badge-warning">Compass Navigator</span>
                    <br /><br />
                    <div id="nav" ></div>   
                </div>
            </div>
            <div class="row">
                <div class="col-md-12" style="padding:3px;">
<form method="post" action="/data/add_profile">
  <div class="form-row align-items-center">
    <div class="col-sm-5 my-1">
      <label class="sr-only" for="inlineFormInputName">Profile</label>
      <input type="text" name="profile" class="form-control" id="inlineFormInputName" placeholder="Your profile record">
    </div>
    <div class="col-auto my-1">
      <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Profile</button>
      <a href="/" class="btn btn-primary"> <i class="fas fa-sync"></i> Refresh</a>
    </div>
  </div>
</form>
{% for i in profile_list  %}
    {% if i[2] == 1 %}
    <a href="#" class="btn btn-sm btn-warning" >{{ i[1] }}</a>
    {% endif %}
    {% if i[2] == 0 %}
    <a href="/data/set_profile/{{i[0]}}" class="btn btn-sm btn-success">{{ i[1] }}</a>
    {% endif %}
{% endfor %}
                </div>
            </div>
        </div>
    </div>
            <div class="row">
                <div class="col-md-12" style="">
                    <span class="badge badge-warning">Record Data</span>
                    <table style="margin-top:3px;" class="table table-striped table-bordered table-dark">
                      <thead>
                        <tr>
                          <th scope="col">Timestamp</th>
                          <th scope="col">X</th>
                          <th scope="col">Y</th>
                          <th scope="col">Z</th>
                          <th scope="col">Azimuth</th>
                          <th scope="col">Bearing</th>
                          <th scope="col">Direction</th>
                          <th scope="col">Temperature</th>
                          <th scope="col">Pressure</th>
                          <th scope="col">altitude</th>
                          <th scope="col">GPS Latitude</th>
                          <th scope="col">GPS Longitude</th>
                          <th scope="col">GPS Altitude</th>
                          <th scope="col">GPS Age</th>
                          <th scope="col">GPS Sat</th>
                          <th scope="col">GPS Course</th>
                          <th scope="col">GPS Speed</th>
                          <th scope="col">RSSI</th>
                        </tr>
                      </thead>
                      <tbody>

                        <tr>
                          <td id="tms"></td>
                          <td id="x"></td>
                          <td id="y"></td>
                          <td id="z"></td>
                          <td id="azimuth"></td>
                          <td id="bearing"></td>
                          <td id="direction"></td>
                          <td id="temperature"></td>
                          <td id="pressure"></td>
                          <td id="altitude"></td>
                          <td id="gps_latitude"></td>
                          <td id="gps_longitude"></td>
                          <td id="gps_altitude"></td>
                          <td id="gps_age"></td>
                          <td id="gps_sat"></td>
                          <td id="gps_course"></td>
                          <td id="gps_speed"></td>
                          <td id="rssi"></td>
                        </tr>
                      </tbody>
                    </table>
                </div>
            </div>

    <div class="row">
        <div id='app_map' class="col-md-6" style="padding:0 !important;">
        </div>
        <div id="map" class="col-md-6" style="padding:0 !important;height:440px;">
        </div>
    </div>
</div>
    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/jQueryRotate.2.2.js"></script>        
    <script type="text/javascript" src="/static/js/CompassRoss.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/data.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.7.0/build/ol.js"></script>
    <script src='https://cdn.plot.ly/plotly-2.4.2.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
    <script type="text/javascript">
        window.data_list = [];

        var map = new ol.Map({
          target: 'map',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM()
            })
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([ 107.68213482329772, -7.661243419310371]),
            zoom: 15
          })
        });

        var centerLongitudeLatitude = ol.proj.fromLonLat([107.68213482329772, -7.661243419310371]);
        var layer = new ol.layer.Vector({
          source: new ol.source.Vector({
            projection: 'EPSG:4326',
            features: [new ol.Feature(new ol.geom.Circle(centerLongitudeLatitude, 300))]
          }),
          style: [
            new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'blue',
                width: 3
              }),
              fill: new ol.style.Fill({
                color: 'rgba(0, 0, 255, 0.1)'
              })
            })
          ]
        });
        map.addLayer(layer);

    </script>
    <script type="text/javascript">
        $(document).ready(function() {            
            $('#nav').CompassRose({pos: 0});

            var last_bearing = 0;
            setInterval(function() {
                var data_list = [];
                window.data_list.forEach(function(row){
                    data_list.push({x: row[1]/100, y: row[2]/100, z: row[3]/100, color: '2'});
                });

                function unpack(rows, key) {
                    return rows.map(function(row){ 
                        return row[key]; 
                    }); 
                }

                var x = unpack(data_list,'x');
                var y = unpack(data_list,'y');
                var z = unpack(data_list,'z')
                var c = unpack(data_list,'color');
                
                Plotly.newPlot('app_map', [{
                  type: 'scatter3d',
                  mode: 'lines',
                  x: x,
                  y: y,
                  z: z,
                  opacity: 1,
                  line: {
                    width: 6,
                    color: c,
                    reversescale: false
                  }
                }], {
                  height: 440
                });

            },1000);
            
            setInterval(function() {
                $.get( "/data/last_one", function( json ) {

                    window.data_list.push(...[json.data]);

                    var new_bearing = parseInt(json.data[5]);
                    new_bearing = 22.5 * new_bearing;
                    if(last_bearing != new_bearing) {
                        /*
                        - Getting 16 point Azimuth bearing direction (0 - 15).
                        - Getting 16 point Azimuth bearing Names (N, NNE, NE, ENE, E, ESE, SE, SSE, S, SSW, SW, WSW, W, WNW, NW, NNW)
                        */
                        $('.imgB1').rotate({ angle:last_bearing,animateTo:new_bearing,easing: $.easing.easeInOutExpo });
                        last_bearing = new_bearing;
                    }

                    $('#tms').html('').html(json.data[18]);
                    $('#x').html('').html(json.data[1]);
                    $('#y').html('').html(json.data[2]);
                    $('#z').html('').html(json.data[3]);
                    $('#azimuth').html('').html(json.data[4]);
                    $('#bearing').html('').html(json.data[5]);
                    $('#direction').html('').html(json.data[6]);
                    $('#temperature').html('').html(json.data[7]);
                    $('#pressure').html('').html(json.data[8]);
                    $('#altitude').html('').html(json.data[9]);
                    $('#gps_latitude').html('').html(json.data[10]);
                    $('#gps_longitude').html('').html(json.data[11]);
                    $('#gps_age').html('').html(json.data[12]);
                    $('#gps_altitude').html('').html(json.data[13]);
                    $('#gps_sat').html('').html(json.data[14]);
                    $('#gps_course').html('').html(json.data[15]);
                    $('#gps_speed').html('').html(json.data[16]);
                    $('#rssi').html('').html(json.data[17]);

                    
                });
            },333);
        })
    </script>
<script type="text/javascript">
    /*
    var mymap = L.map('mapid').setView([51.505, -0.09], 13);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
    }).addTo(mymap);

    L.marker([51.5, -0.09]).addTo(mymap)
        .bindPopup("<b>Route!</b><br />tracking.").openPopup();


    var popup = L.popup();

    function onMapClick(e) {
        popup
            .setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(mymap);
    }

    mymap.on('click', onMapClick);
    */

Highcharts.theme = {
    colors: ['#2b908f', '#90ee7e', '#f45b5b', '#7798BF', '#aaeeee', '#ff0066',
        '#eeaaee', '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'],
    chart: {
        backgroundColor: {
            linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
            stops: [
                [0, '#2a2a2b'],
                [1, '#3e3e40']
            ]
        },
        style: {
            fontFamily: '\'Unica One\', sans-serif'
        },
        plotBorderColor: '#606063'
    },
    title: {
        style: {
            color: '#E0E0E3',
            textTransform: 'uppercase',
            fontSize: '20px'
        }
    },
    subtitle: {
        style: {
            color: '#E0E0E3',
            textTransform: 'uppercase'
        }
    },
    xAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    yAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        tickWidth: 1,
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        style: {
            color: '#F0F0F0'
        }
    },
    plotOptions: {
        series: {
            dataLabels: {
                color: '#F0F0F3',
                style: {
                    fontSize: '13px'
                }
            },
            marker: {
                lineColor: '#333'
            }
        },
        boxplot: {
            fillColor: '#505053'
        },
        candlestick: {
            lineColor: 'white'
        },
        errorbar: {
            color: 'white'
        }
    },
    legend: {
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        itemStyle: {
            color: '#E0E0E3'
        },
        itemHoverStyle: {
            color: '#FFF'
        },
        itemHiddenStyle: {
            color: '#606063'
        },
        title: {
            style: {
                color: '#C0C0C0'
            }
        }
    },
    credits: {
        style: {
            color: '#666'
        }
    },
    labels: {
        style: {
            color: '#707073'
        }
    },
    drilldown: {
        activeAxisLabelStyle: {
            color: '#F0F0F3'
        },
        activeDataLabelStyle: {
            color: '#F0F0F3'
        }
    },
    navigation: {
        buttonOptions: {
            symbolStroke: '#DDDDDD',
            theme: {
                fill: '#505053'
            }
        }
    },
    // scroll charts
    rangeSelector: {
        buttonTheme: {
            fill: '#505053',
            stroke: '#000000',
            style: {
                color: '#CCC'
            },
            states: {
                hover: {
                    fill: '#707073',
                    stroke: '#000000',
                    style: {
                        color: 'white'
                    }
                },
                select: {
                    fill: '#000003',
                    stroke: '#000000',
                    style: {
                        color: 'white'
                    }
                }
            }
        },
        inputBoxBorderColor: '#505053',
        inputStyle: {
            backgroundColor: '#333',
            color: 'silver'
        },
        labelStyle: {
            color: 'silver'
        }
    },
    navigator: {
        handles: {
            backgroundColor: '#666',
            borderColor: '#AAA'
        },
        outlineColor: '#CCC',
        maskFill: 'rgba(255,255,255,0.1)',
        series: {
            color: '#7798BF',
            lineColor: '#A6C7ED'
        },
        xAxis: {
            gridLineColor: '#505053'
        }
    },
    scrollbar: {
        barBackgroundColor: '#808083',
        barBorderColor: '#808083',
        buttonArrowColor: '#CCC',
        buttonBackgroundColor: '#606063',
        buttonBorderColor: '#606063',
        rifleColor: '#FFF',
        trackBackgroundColor: '#404043',
        trackBorderColor: '#404043'
    }
};
// Apply the theme
Highcharts.setOptions(Highcharts.theme);


function createChart() {


    var data_list = [];
    var dt_series = [];

        window.data_list.forEach(function(row){
            data_list.push({temperature: row[7], altitude: row[9], speed: row[16], color: '2'});
        });

        function unpack(rows, key) {
            return rows.map(function(row){ 
                return row[key]; 
            }); 
        }

        dt_series.push({
            name: 'Altitude',
            data: (function () {
            // generate an array of random data
            var data = [],
                time = (new Date()).getTime(),
                i;

            for (i = -19; i <= 0; i += 1) {
                data.push({
                    x: time + i * 1000,
                    y: Math.random()
                });
            }
            return data;
            }())
        });

        dt_series.push({
            name: 'Temperature',
            data: (function () {
            // generate an array of random data
            var data = [],
                time = (new Date()).getTime(),
                i;

            for (i = -19; i <= 0; i += 1) {
                data.push({
                    x: time + i * 1000,
                    y: Math.random()
                });
            }
            return data;
            }())
        });

    Highcharts.chart('chart2', {
        chart: {
            type: 'spline',
            animation: Highcharts.svg, // don't animate in old IE
            marginRight: 10,
            events: {
                load: function () {
                    // set up the updating of the chart each second
                    var series0 = this.series[0];
                    setInterval(function () {
                        var x = (new Date()).getTime(), // current time
                            y = Math.random();
                        series0.addPoint([x, y], true, true);
                    }, 1000);

                    var series1 = this.series[1];
                    setInterval(function () {
                        var x = (new Date()).getTime(), // current time
                            y = Math.random();
                        series1.addPoint([x, y], true, true);
                    }, 1000);
                }
            }
        },

        time: {
            useUTC: false
        },

        title: {
            text: 'Live data'
        },

        accessibility: {
            announceNewData: {
                enabled: true,
                minAnnounceInterval: 15000,
                announcementFormatter: function (allSeries, newSeries, newPoint) {
                    if (newPoint) {
                        return 'New point added. Value: ' + newPoint.y;
                    }
                    return false;
                }
            }
        },

        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150
        },

        yAxis: {
            title: {
                text: 'Value'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },

        tooltip: {
            headerFormat: '<b>{series.name}</b><br/>',
            pointFormat: '{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.2f}'
        },

        legend: {
            enabled: true
        },

        exporting: {
            enabled: true
        },

        series: dt_series
    });
}


// Create the chart
createChart();

/*
setInterval(function() {
    var data_list = [];
    window.data_list.forEach(function(row){
        data_list.push({temperature: row[7], altitude: row[9], speed: row[16], color: '2'});
    });

    function unpack(rows, key) {
        return rows.map(function(row){ 
            return row[key]; 
        }); 
    }

    var dt_series = [];
    dt_series.push({
        name: 'Altitude',
        data: unpack(data_list,'altitude')
    });
    dt_series.push({
        name: 'Temperature',
        data: unpack(data_list,'temperature')
    });
    dt_series.push({
        name: 'Speed',
        data: unpack(data_list,'speed')
    });

    Highcharts.chart('chart2', {
        chart: {
            type: 'spline',
            scrollablePlotArea: {
                minWidth: 600,
                scrollPositionX: 1
            }
        },
        title: {
            text: 'Analysis (Alt+Temp)',
            align: 'left'
        },
        subtitle: {
            text: '09/21/2021 08:43',
            align: 'left'
        },
        xAxis: {
            type: 'datetime',
            labels: {
                overflow: 'justify'
            }
        },
        yAxis: {
            title: {
                text: 'Value'
            },
            minorGridLineWidth: 0,
            gridLineWidth: 0,
            alternateGridColor: null,
        },
        tooltip: {
            valueSuffix: ''
        },
        plotOptions: {
            spline: {
                lineWidth: 4,
                states: {
                    hover: {
                        lineWidth: 5
                    }
                },
                marker: {
                    enabled: false
                },
                pointInterval: 1000, // one hour
                pointStart: Date.UTC(2021, 1, 13, 0, 0, 0)
            }
        },
        series:dt_series,
        navigation: {
            menuItemStyle: {
                fontSize: '10px'
            }
        }
    });

},1000);
*/
</script>
</body>
</html>